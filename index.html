<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©mineur Multijoueur</title>
    <style>
        /* Simple CSS pour styliser l'interface */
        body {
            font-family: Arial, sans-serif;
        }
        #login {
            display: block;
        }
        #game, #invitation {
            display: none;
        }
        #players {
            list-style-type: none;
        }
        table {
            border-collapse: collapse;
        }
        td {
            width: 30px;
            height: 30px;
            text-align: center;
            border: 1px solid #000;
            cursor: pointer;
        }
        td.flag {
            background-color: white;
        }
        td.revealed {
            background-color: lightgray;
        }
        #messages {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #f1f1f1;
            padding: 10px;
            max-height: 150px;
            overflow-y: scroll;
            font-size: 12px;
        }
        #gameBoard {
            margin-bottom: 150px; /* Assurez-vous que le plateau n'√©crase pas la div des messages */
        }
        #winnerModal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        #winnerModalContent {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Formulaire de connexion -->
    <div id="login">
        <h2>Connexion / Cr√©ation de compte</h2>
        <input type="text" id="username" placeholder="Nom d'utilisateur">
        <input type="password" id="password" placeholder="Mot de passe">
        <button id="loginBtn">Connexion</button>
        <button id="registerBtn">Cr√©er un compte</button>
        <p id="loginError"></p>
    </div>

    <!-- Zone de jeu -->
    <div id="game">
        <h2>Bienvenue, <span id="userDisplay"></span></h2>
        <button id="logoutBtn">D√©connexion</button>
        
        <!-- Liste des joueurs connect√©s -->
        <div id="availableUser">
            <h3>Joueurs disponibles</h3>
            <ul id="players"></ul>
        </div>

        <!-- Invitation -->
        <div id="invitation">
            <p>Invitation re√ßue de <span id="inviter"></span></p>
            <button id="acceptInviteBtn">Accepter</button>
            <button id="declineInviteBtn">Refuser</button>
        </div>

        <!-- Plateau de jeu -->
        <div id="gameBoard"></div>
    </div>

    <div id="winnerModal">
        <div id="winnerModalContent">
            <h2 id="winnerMessage"></h2>
            <button id="closeModalBtn">Fermer</button>
        </div>
    </div>

    <!-- Div pour afficher les messages WebSocket -->
    <div id="messages"></div>

    <script>
        let socket;
        let username;
        let currentGameId;

        // Fonction pour afficher les messages WebSocket dans la div messages
        function logMessage(message) {
            const messageDiv = document.getElementById('messages');
            const messageElement = document.createElement('p');
            messageElement.textContent = message;
            messageDiv.appendChild(messageElement);

            // Faire d√©filer automatiquement vers le bas quand un nouveau message est ajout√©
            messageDiv.scrollTop = messageDiv.scrollHeight;
        }

        // Afficher la liste des joueurs disponibles
        function updatePlayerList(players) {
            const playersList = document.getElementById('players');
            playersList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player.username;
                li.dataset.playerId = player.id;
                li.addEventListener('click', () => invitePlayer(player.id));
                playersList.appendChild(li);
            });
        }

        // Gestion des invitations
        function invitePlayer(playerId) {
            socket.send(JSON.stringify({ type: 'invite', invitee: playerId }));
            logMessage('Invitation envoy√©e √† ' + playerId);
        }

        function acceptInvite() {
            const inviter = document.getElementById('inviter').textContent;  // Nom de l'inviteur
            socket.send(JSON.stringify({
                type: 'accept_invite',
                inviter: inviter  // Envoi du nom de l'inviteur
            }));
            document.getElementById('invitation').style.display = 'none';
            logMessage('Invitation accept√©e de ' + inviter);
        }

        function declineInvite() {
            const inviter = document.getElementById('inviter').textContent;
            socket.send(JSON.stringify({ type: 'decline_invite', inviter }));
            document.getElementById('invitation').style.display = 'none';
            logMessage('Invitation refus√©e de ' + inviter);
        }

        // 

        // Afficher le plateau de jeu
        function displayGameBoard(board) {
            const gameBoardDiv = document.getElementById('gameBoard');
            gameBoardDiv.innerHTML = ''; // R√©initialiser le plateau de jeu

            const table = document.createElement('table');
            board.forEach((row, x) => {
                const tr = document.createElement('tr');
                row.forEach((cell, y) => {
                    const td = document.createElement('td');
                    td.dataset.x = x;
                    td.dataset.y = y;

                    if (cell.revealed) {
                        td.classList.add('revealed');
                        td.textContent = cell.mine ? 'üí£' : (cell.adjacentMines || '');
                    } else if (cell.flagged) {
                        td.classList.add('flag');
                        td.textContent = 'üö©';
                    }

                    // Gestion des clics (r√©v√©lation des cases)
                    td.addEventListener('click', () => revealCell(x, y));
                    // Clic droit pour placer ou retirer un drapeau
                    td.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        placeFlag(x, y);
                    });

                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
            gameBoardDiv.appendChild(table);
        }

        // Fonction pour vider le plateau de jeu
        function clearGameBoard() {
            const gameBoardDiv = document.getElementById('gameBoard');
            gameBoardDiv.innerHTML = '';  // Supprimer tout le contenu du plateau de jeu
            logMessage('Le plateau de jeu a √©t√© vid√©.');
}

        // Connexion WebSocket
        function connectWebSocket() {
            socket = new WebSocket('ws://192.168.1.170:8080');

            socket.onopen = function() {
                logMessage('WebSocket ouvert');
            };

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                logMessage('Message re√ßu du serveur: ' + JSON.stringify(data));

                switch (data.type) {
                    case 'login_failed':
                        // Afficher le message d'erreur et r√©initialiser les inputs
                        document.getElementById('loginError').textContent = 'Login ou mot de passe incorrect.';
                        document.getElementById('username').value = '';
                        document.getElementById('password').value = '';
                        break;

                    case 'login_success':
                        // Masquer la section de connexion et afficher la liste des joueurs
                        document.getElementById('login').style.display = 'none';
                        document.getElementById('game').style.display = 'block';
                        document.getElementById('userDisplay').textContent = data.username;
                        updatePlayerList(data.players);
                        break;

                    case 'connected_players':
                        // Masquer la section de connexion et afficher la liste des joueurs
                        document.getElementById('login').style.display = 'none';
                        document.getElementById('game').style.display = 'block';
                        document.getElementById('userDisplay').textContent = data.username;
                        // Rafra√Æchir la liste des joueurs connect√©s
                        refreshPlayersList(data.players);
                        break;

                    case 'game_start':
                        // Stocker le game_id pour les futures actions
                        document.getElementById('availableUser').style.display = 'none';
                        currentGameId = data.game_id;
                        displayGameBoard(data.board);
                        logMessage('Tour actuel: ' + data.turn);
                        break;

                    case 'update_board':
                        displayGameBoard(data.board);
                        break;

                    case 'invite':
                        document.getElementById('inviter').textContent = data.inviter;
                        document.getElementById('invitation').style.display = 'block';
                        break;

                    case 'invite_declined':
                        logMessage('Invitation refus√©e par le joueur.');
                        break;

                    case 'game_over':
                        // Fin de partie et affichage du gagnant
                        displayGameBoard(data.board);
                        showWinnerModal(data.winner, data.game_id);
                        
                        break;

                    case 'error':
                        logMessage('Erreur: ' + data.message);
                        break;

                    // Autres types de messages...
                }
            };

            socket.onclose = function() {
                logMessage('WebSocket ferm√©');
            };
        }

        // Rafra√Æchir la liste des joueurs connect√©s
        function refreshPlayersList(players) {
            const playersList = document.getElementById('players');
            playersList.innerHTML = '';
            players.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player.username;
                li.dataset.playerId = player.id;
                li.addEventListener('click', () => invitePlayer(player.id));
                playersList.appendChild(li);
            });
        }

        // Gestion des cellules
        function revealCell(x, y) {
            if (currentGameId) {  // V√©rifiez que le game_id est bien d√©fini
                socket.send(JSON.stringify({
                    type: 'reveal_cell',
                    game_id: currentGameId,  // Utilisez le game_id stock√©
                    x: x,
                    y: y
                }));
                logMessage('Cellule r√©v√©l√©e: (' + x + ', ' + y + ')');
            } else {
                console.error('game_id manquant lors de la r√©v√©lation de la cellule');
            }
        }

        function placeFlag(x, y) {
            if (currentGameId) {  // V√©rifiez que le game_id est bien d√©fini
                socket.send(JSON.stringify({
                    type: 'place_flag',
                    game_id: currentGameId,  // Utilisez le game_id stock√©
                    x: x,
                    y: y
                }));
                logMessage('Drapeau pos√©: (' + x + ', ' + y + ')');
            } else {
                console.error('game_id manquant lors du placement du drapeau');
            }
        }

        // Afficher le modal du gagnant
        function showWinnerModal(winnerMessage, gameId) {
            currentGameId = gameId;
            const modal = document.getElementById('winnerModal');
            const message = document.getElementById('winnerMessage');
            message.textContent = winnerMessage;
            modal.style.display = 'flex';
        }

        // Fermer la modale du gagnant
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('winnerModal').style.display = 'none';
            document.getElementById('availableUser').style.display = 'block';
            clearGameBoard();
            socket.send(JSON.stringify({
                type: 'ready_for_new_game',
                game_id: currentGameId
            }));
        });

        // Gestion des √©v√©nements de connexion et d√©connexion
        document.getElementById('loginBtn').addEventListener('click', () => {
            username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            socket.send(JSON.stringify({
                type: 'login',
                username: username,
                password: password
            }));
            logMessage('Tentative de connexion pour ' + username);
        });

        document.getElementById('registerBtn').addEventListener('click', () => {
            username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            socket.send(JSON.stringify({
                type: 'register',
                username: username,
                password: password
            }));
            logMessage('Tentative de cr√©ation de compte pour ' + username);
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            clearGameBoard(); 
            socket.send(JSON.stringify({ type: 'logout' }));
            document.getElementById('login').style.display = 'block';
            document.getElementById('game').style.display = 'none';
            logMessage('D√©connexion de ' + username);
        });

        document.getElementById('acceptInviteBtn').addEventListener('click', acceptInvite);
        document.getElementById('declineInviteBtn').addEventListener('click', declineInvite);

        // D√©marrer la connexion WebSocket lors du chargement de la page
        window.onload = function() {
            connectWebSocket();
        };
    </script>
</body>
</html>
